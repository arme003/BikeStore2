from UI.view import View
from model.model_app import Model
import flet as ft
import datetime

class Controller:
    def __init__(self, view: View, model: Model):
        self.view = view
        self.model = model

    def set_dates(self):
        first, last = self.model.get_date_range()

        self.view.dp1.first_date = datetime.date(first.year, first.month, first.day)
        self.view.dp1.last_date = datetime.date(last.year, last.month, last.day)
        self.view.dp1.current_date = datetime.date(first.year, first.month, first.day)

        self.view.dp2.first_date = datetime.date(first.year, first.month, first.day)
        self.view.dp2.last_date = datetime.date(last.year, last.month, last.day)
        self.view.dp2.current_date = datetime.date(last.year, last.month, last.day)

    def populate_dd_category(self):
        lista=self.model.load_cateogories()
        if len(lista)==0:
            print("Lista categorie vuota")
            return []
        self.view.dd_category.options.clear()
        for n in lista:
            id=n.id
            name=n.name
            self.view.dd_category.options.append(ft.dropdown.Option(key=id,text=name))
        self.view.update()



    def handle_crea_grafo(self, e):
        category=self.view.dd_category.value
        anno1=self.view.dp1.value
        anno2=self.view.dp2.value
        grafo=self.model.build_graph(category, anno1, anno2)
        num_nodes=self.model.grafo.number_of_nodes()
        num_archi=self.model.grafo.number_of_edges()
        lista=self.model.get_lista()#nome,score
        self.view.txt_risultato.controls.clear()
        self.view.txt_risultato.controls.append(ft.Text(f"Date selezionate\n"
                                                        f"Start date: {anno1}\n"
                                                        f"End date: {anno2}\n"
                                                        f"Grafo correttamente creato:\n"
                                                        f"Numero di nodi: {num_nodes}\n"
                                                        f"Numero di archi: {num_archi}\n\n\n"
                                                        f"I cinque prodotti pi√π venduti sono:"))
        for nome,score in lista:
            self.view.txt_risultato.controls.append(ft.Text(f"{nome} with score: {score}"))
        self.view.update()


    def handle_best_prodotti(self, e):
        pass

    def handle_cerca_cammino(self, e):
        pass
